name: Auto-generate Changelog

on:
  # Trigger on new tags (releases)
  push:
    tags:
      - 'v*'
  
  # Allow manual triggering with version parameter
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to generate changelog for'
        required: true
        type: string
      since_tag:
        description: 'Generate changelog since this tag (optional)'
        required: false
        type: string

jobs:
  generate-changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for git log
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Determine version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "push" ]]; then
          # Extract version from tag (remove 'v' prefix)
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "is_tag_push=true" >> $GITHUB_OUTPUT
        else
          # Manual dispatch
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          echo "is_tag_push=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Generate changelog
      id: changelog
      run: |
        python3 scripts/generate_changelog.py \
          --version "${{ steps.version.outputs.version }}" \
          ${{ github.event.inputs.since_tag && format('--since {0}', github.event.inputs.since_tag) || '' }} \
          --output CHANGELOG.md
        
        echo "changelog_updated=true" >> $GITHUB_OUTPUT
    
    - name: Check for changes
      id: changes
      run: |
        if git diff --quiet CHANGELOG.md; then
          echo "changes_detected=false" >> $GITHUB_OUTPUT
          echo "No changelog changes detected"
        else
          echo "changes_detected=true" >> $GITHUB_OUTPUT
          echo "Changelog changes detected"
        fi
    
    - name: Commit and push changelog (for tag pushes)
      if: steps.version.outputs.is_tag_push == 'true' && steps.changes.outputs.changes_detected == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add CHANGELOG.md
        git commit -m "docs: auto-generate changelog for v${{ steps.version.outputs.version }}

        🤖 Generated with [Claude Code](https://claude.ai/code)

        Co-Authored-By: Claude <noreply@anthropic.com>"
        
        # Push to the main branch, not the tag
        git push origin HEAD:master
    
    - name: Create pull request (for manual triggers)
      if: steps.version.outputs.is_tag_push == 'false' && steps.changes.outputs.changes_detected == 'true'
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          docs: auto-generate changelog for v${{ steps.version.outputs.version }}

          🤖 Generated with [Claude Code](https://claude.ai/code)

          Co-Authored-By: Claude <noreply@anthropic.com>
        title: "📝 Auto-generate changelog for v${{ steps.version.outputs.version }}"
        body: |
          ## Auto-generated Changelog Update

          This PR automatically updates the changelog with conventional commits for version `v${{ steps.version.outputs.version }}`.

          ### Changes Made:
          - ✅ Generated changelog entries from conventional commit messages
          - ✅ Organized commits by type (Added, Fixed, Documentation, etc.)
          - ✅ Added commit hashes for reference
          - ✅ Maintained Keep a Changelog format

          ### Review Checklist:
          - [ ] Verify all important changes are included
          - [ ] Check that breaking changes are properly marked
          - [ ] Ensure changelog format is correct
          - [ ] Confirm version number is accurate

          This changelog was automatically generated from git commits following the [Conventional Commits](https://www.conventionalcommits.org/) specification.

          🤖 *Generated by GitHub Actions*
        branch: changelog/v${{ steps.version.outputs.version }}
        delete-branch: true
        labels: |
          documentation
          automated
    
    - name: Summary
      run: |
        echo "### 📝 Changelog Generation Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Changes detected**: ${{ steps.changes.outputs.changes_detected }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ steps.changes.outputs.changes_detected }}" == "true" ]]; then
          echo "✅ Changelog updated successfully" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.version.outputs.is_tag_push }}" == "true" ]]; then
            echo "📤 Changes committed to master branch" >> $GITHUB_STEP_SUMMARY
          else
            echo "🔄 Pull request created for review" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "ℹ️ No new conventional commits found" >> $GITHUB_STEP_SUMMARY
        fi