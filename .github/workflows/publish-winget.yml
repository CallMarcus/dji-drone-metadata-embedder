name: Publish winget package

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  publish-winget:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          winget install --id Microsoft.WingetCreate -e --accept-source-agreements --accept-package-agreements --silent
      - name: Build executable
        run: pyinstaller --onefile -n dji-embed dji_metadata_embedder/embedder.py
      - name: Publish via wingetcreate
        env:
          WINGET_TOKEN: ${{ secrets.WINGET_GITHUB_TOKEN }}
        run: |
          $version = (Select-String -Path pyproject.toml -Pattern '^version').Line.Split('=')[1].Trim().Trim('"')
          $tag = "v$version"
          $url = "https://github.com/${{ github.repository }}/releases/download/$tag/dji-embed.exe"
          wingetcreate update CallMarcus.DJI-Embed -v $version -u $url -t $env:WINGET_TOKEN -m .github/winget/installer.yaml --submit
          $pyUrl = "https://github.com/${{ github.repository }}/releases/download/$tag/python.zip"
          wingetcreate update CallMarcus.DJI-Embed.Python -v $version -u $pyUrl -t $env:WINGET_TOKEN -m .github/winget/python.yaml --submit
          $ffUrl = "https://github.com/${{ github.repository }}/releases/download/$tag/ffmpeg.zip"
          wingetcreate update CallMarcus.DJI-Embed.FFmpeg -v $version -u $ffUrl -t $env:WINGET_TOKEN -m .github/winget/ffmpeg.yaml --submit
          $exUrl = "https://github.com/${{ github.repository }}/releases/download/$tag/exiftool.zip"
          wingetcreate update CallMarcus.DJI-Embed.ExifTool -v $version -u $exUrl -t $env:WINGET_TOKEN -m .github/winget/exiftool.yaml --submit
